/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(h,a){return parseFloat(h.style["z-index"]||0)-parseFloat(a.style["z-index"]||0)}function c(h,B,d,f,r){var m=d.features,d=[],e,j,k,l,i,u;e=0;for(k=m.length;e<k;e++){i=l=m[e];u=f;var p=r,b=0;if(p)b=p.kothicId=p.kothicId||++q;var c=void 0,n=void 0,b=[b,JSON.stringify(i.properties),u,i.type].join(":");if(!g[b]){if(i.type=="Polygon"||i.type=="MultiPolygon")c="way",n="area";else if(i.type=="LineString"||i.type=="MultiLineString")c="way",n="line";else if(i.type=="Point"||
i.type=="MultiPoint")n=c="node";g[b]=g[b]||{};g[b]=MapCSS.restyle(g[b],i.properties,u,c,n);p&&p(g[b],i.properties,u,c,n)}i=g[b];for(j in i)if(i.hasOwnProperty(j)){u={};p=l;c=void 0;for(c in p)p.hasOwnProperty(c)&&(u[c]=p[c]);u.kothicId=e+1;u.style=i[j];d.push(u)}}d.sort(a);f=0;for(r=d.length;f<r;f++)j=d[f],m=parseFloat(j.properties.layer)||0,e=j.style["-x-mapnik-layer"],e=="top"&&(m=1E4),e=="bottom"&&(m=-1E4),m in h||(h[m]=[],B.push(m)),h[m].push(j);B.sort()}function n(h,a){for(var d in a)a.hasOwnProperty(d)&&
(h[d]=a[d])}function o(h,a,d){var f=a["fill-opacity"]||a.opacity;"fill-color"in a&&(n(h,{fillStyle:a["fill-color"]||"#000000",globalAlpha:f||1}),d());if("fill-image"in a&&(a=MapCSS.getImage(a["fill-image"])))n(h,{fillStyle:h.createPattern(a,"repeat"),globalAlpha:f||1}),d()}function p(h,a,d,f){var g={},g=MapCSS.restyle(g,{},f,"canvas","canvas")["default"];o(h,g,function(){h.fillRect(-1,-1,a+1,d+1)})}function t(a,d,g,f,i,b){var e=d.style,j=g&&g.style;m||(m=!0,a.beginPath());Kothic.path(a,d,!1,!0,f,
i,b);if(!g||!(j["fill-color"]==e["fill-color"]&&j["fill-image"]==e["fill-image"]&&j["fill-opacity"]==e["fill-opacity"]))o(a,e,function(){a.fill()}),m=!1}function b(a,d,g){this.buffer=[];this.ctx=a;this.debugBoxes=d;this.debugChecks=g}function d(a,d,g,f,i,b,e,j){var k=d.style,l;a:switch(d.type){case "Point":l=d.coordinates;break;case "Polygon":l=d.reprpoint;break;case "LineString":l=d.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":l=d.reprpoint;break;case "MultiLineString":l=
void 0;break a}if(l){l=[f*l[0],i*(b-l[1])];var m;if(j){m=MapCSS.getImage(k["icon-image"]);if(!m)return;if(k["allow-overlap"]!="true"&&g.checkPointWH(l,m.width,m.height,d.kothicId))return}if(e){var e=k["text-halo-radius"]*2,c;c=k["font-family"];var p=k["font-size"];c=c||"";var p=p||9,t=c?c+", ":"";c=c.toLowerCase();var q=[];(c.indexOf("italic")!=-1||c.indexOf("oblique")!=-1)&&q.push("italic");c.indexOf("bold")!=-1&&(q.push("bold"),t+=c.replace("bold","")+", ");q.push(p+"px");t+=c.indexOf("serif")!=
-1?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif';q.push(t);c=q.join(" ");n(a,{lineWidth:e,font:c});e=k.text+"";p=a.measureText(e).width;t=p/e.length*2.5;q=k["text-offset"]||0;c="text-halo-radius"in k;n(a,{fillStyle:k["text-color"]||"#000000",strokeStyle:k["text-halo-color"]||"#ffffff",globalAlpha:k["text-opacity"]||k.opacity||1,textAlign:"center",textBaseline:"middle"});if(d.type=="Polygon"||d.type=="Point"){if(k["text-allow-overlap"]!="true"&&g.checkPointWH([l[0],l[1]+q],p,t,
d.kothicId))return;c&&a.strokeText(e,l[0],l[1]+q);a.fillText(e,l[0],l[1]+q);f=k["-x-mapnik-min-distance"]||20;g.addPointWH([l[0],l[1]+q],p,t,f,d.kothicId)}else if(d.type=="LineString"){for(var p=d.coordinates,t=[],q=0,o=p.length;q<o;q++)t.push([f*p[q][0],i*(b-p[q][1])]);Kothic.textOnPath(a,t,e,c,g)}}j&&(a.drawImage(m,Math.floor(l[0]-m.width/2),Math.floor(l[1]-m.height/2)),f=parseFloat(k["-x-mapnik-min-distance"])||0,g.addPointWH(l,m.width,m.height,f,d.kothicId))}}var g={},m=!1,q=0,i={strokeStyle:"rgba(0,0,0,0.5)",
fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round",textAlign:"center",textBaseline:"middle"};b.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,d,g,f,c){a=this.getBoxFromPoint(a,d,g,f,c);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var d=0,g=this.buffer.length,f;d<g;d++)if(f=this.buffer[d],!(a[4]&&
a[4]==f[4])&&f[0]<=a[2]&&f[1]<=a[3]&&f[2]>=a[0]&&f[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,d,g,f){return this.checkBox(this.getBoxFromPoint(a,d,g,0,f))},getBoxFromPoint:function(a,d,g,f,c){return[a[0]-d/2-f,a[1]-g/2-f,a[0]+d/2+f,a[1]+g/2+f,c]}};return function(a,g,q,f,r,o){var a=typeof a=="string"?document.getElementById(a):a,
e=a.getContext("2d"),j=a.width,k=a.height,l=g.granularity,y=j/l,u=k/l,x={},F=[],E=new b,G,K,L=+new Date,H,I,J;if(o)G=document.createElement("canvas"),G.width=j,G.height=k,K=e,e=G.getContext("2d");c(x,F,g,q,f);H=+new Date;n(e,i);var M=F.length,C,s,v,D,z,N;N=function(){E.addBox([0,0,j,0]);E.addBox([0,k,j,k]);E.addBox([j,0,j,k]);E.addBox([0,0,0,k]);var a=e.strokeText&&e.fillText&&e.measureText;for(C=M-1;C>=0;C--){v=x[F[C]];D=v.length;for(s=D-1;s>=0;s--)z=v[s].style,"icon-image"in z&&!z.text&&d(e,v[s],
E,y,u,l,!1,!0);for(s=D-1;a&&s>=0;s--)z=v[s].style,z.text&&!("icon-image"in z)&&d(e,v[s],E,y,u,l,!0,!1);for(s=D-1;s>=0;s--)z=v[s].style,"icon-image"in z&&z.text&&d(e,v[s],E,y,u,l,a,!0)}J=+new Date;o&&K.drawImage(G,0,0);r({layersStyled:H-L,mapRendered:I-H,iconsAndTextRendered:J-I,total:J-L})};setTimeout(function(){p(e,j,k,q);for(C=0;C<M;C++){v=x[F[C]];D=v.length;for(s=0;s<D;s++)z=v[s].style,("fill-color"in z||"fill-image"in z)&&t(e,v[s],v[s+1],y,u,l);e.lineCap="butt";for(s=0;s<D;s++)if("casing-width"in
v[s].style){var a=e,d=v[s],g=v[s+1],f=y,c=u,i=l,b=d.style,h=g&&g.style,r=b["casing-dashes"]||b.dashes||!1;m||(m=!0,a.beginPath());Kothic.path(a,d,r,!1,f,c,i);if(!g||!(h.width==b.width&&h["casing-width"]==b["casing-width"]&&h["casing-color"]==b["casing-color"]&&(h["casing-dashes"]||h.dashes||!1)==(b["casing-dashes"]||b.dashes||!1)&&(h["casing-linecap"]||h.linecap||"butt")==(b["casing-linecap"]||b.linecap||"butt")&&(h["casing-linejoin"]||h.linejoin||"round")==(b["casing-linejoin"]||b.linejoin||"round")&&
(h["casing-opacity"]||h.opacity)==(b.opacity||b["casing-opacity"])))n(a,{lineWidth:2*b["casing-width"]+("width"in b?b.width:0),strokeStyle:b["casing-color"]||"#000000",lineCap:b["casing-linecap"]||b.linecap||"butt",lineJoin:b["casing-linejoin"]||b.linejoin||"round",globalAlpha:b["casing-opacity"]||1}),m=!1,a.stroke()}e.lineCap="round";for(s=0;s<D;s++)if(v[s].style.width&&(a=e,d=v[s],g=v[s+1],f=y,c=u,i=l,b=d.style,h=g&&g.style,r=b.dashes,m||(m=!0,a.beginPath()),Kothic.path(a,d,r,!1,f,c,i),!g||!((h.width||
1)==(b.width||1)&&(h.color||"#000000")==(b.color||"#000000")&&h.linecap==b.linecap&&h.linejoin==b.linejoin&&h.image==b.image&&h.opacity==b.opacity))){if("color"in b||not("image"in b))n(a,{lineWidth:b.width||1,strokeStyle:b.color||"#000000",lineCap:b.linecap||"round",lineJoin:b.linejoin||"round",globalAlpha:b.opacity||1}),a.stroke();if("image"in b&&(image=MapCSS.getImage(b.image)))n(a,{strokeStyle:a.createPattern(image,"repeat")||"#000000",lineWidth:b.width||1,lineCap:b.linecap||"round",lineJoin:b.linejoin||
"round",globalAlpha:b.opacity||1}),a.stroke();m=!1}I=+new Date}setTimeout(N,0)},0)}}();var MapCSS={styles:{},currentStyles:[],onError:function(){},onImagesLoad:function(){},images:{},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,c){return c in
a&&a[c]!==null?a[c]:""},e_prop:function(a,c){return c in a&&a[c]!==null?a[c]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,c,n){return MapCSS.e_boolean(a)=="true"?c:n},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,c,n,o){MapCSS.styles[a]={restyle:c,images:n,external_images:o,textures:{},sprite_loaded:!n,external_images_loaded:!o.length};MapCSS.currentStyles.push(a)},_onImagesLoad:function(a){if(MapCSS.styles[a].external_images_loaded&&MapCSS.styles[a].sprite_loaded)MapCSS.onImagesLoad()},preloadSpriteImage:function(a,c){var n=MapCSS.styles[a].images;delete MapCSS.styles[a].images;var o=new Image;o.onload=function(){for(var c in n)if(n.hasOwnProperty(c))n[c].sprite=
o,MapCSS.images[c]=n[c];MapCSS.styles[a].sprite_loaded=!0;MapCSS._onImagesLoad(a)};o.onerror=function(a){MapCSS.onError(a)};o.src=c},preloadExternalImages:function(a){var c=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var n=c.length,o=0,p=0;p<n;p++)(function(c){var b=new Image;b.onload=function(){o++;MapCSS.images[c]={sprite:b,height:b.height,width:b.width,offset:0};if(o==n)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};b.onerror=function(){o++;
if(o==n)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};b.src=c})(c[p])},getImage:function(a){var c=MapCSS.images[a];if(c.sprite){var n=document.createElement("canvas");n.width=c.width;n.height=c.height;n.getContext("2d").drawImage(c.sprite,0,c.offset,c.width,c.height,0,0,c.width,c.height);c=MapCSS.images[a]=n}return c},restyle:function(a,c,n,o,p){for(var t,b=0;b<MapCSS.currentStyles.length;b++)t=MapCSS.currentStyles[b],a=MapCSS.styles[t].restyle(a,c,n,o,p);return a}};Kothic.path=function(){function a(a,c){o={pattern:c,seg:0,phs:0,x:a[0],y:a[1]}}function c(a,c){var b=o,d=c[0]-b.x,g=c[1]-b.y,m=Math.sqrt(d*d+g*g),q;a.save();a.translate(b.x,b.y);a.rotate(Math.atan2(g,d));a.moveTo(0,0);d=0;do{q=b.pattern[b.seg];d+=q-b.phs;g=d<m;if(!g)b.phs=q-(d-m),d=m;a[b.seg%2?"moveTo":"lineTo"](d,0);if(g)b.phs=0,b.seg=++b.seg%b.pattern.length}while(g);b.x=c[0];b.y=c[1];a.restore()}function n(a,c){return a[0]===0||a[0]==c||a[1]===0||a[1]==c}var o;return function(p,t,b,d,g,m,q){var i=
t.type,t=t.coordinates;i=="Polygon"&&(t=[t],i="MultiPolygon");i=="LineString"&&(t=[t],i="MultiLineString");var h,o,w,f,r=t.length,A,e,j,k,l;if(i=="MultiPolygon")for(h=0;h<r;h++){w=0;for(A=t[h].length;w<A;w++){f=t[h][w];e=f.length;j=f[0];for(o=0;o<=e;o++)k=f[o]||f[0],l=[g*k[0],m*(q-k[1])],o===0||!d&&n(k,q)&&n(j,q)?(j=b,p.moveTo(l[0],l[1]),j&&a(l,j)):d||!b?p.lineTo(l[0],l[1]):c(p,l),j=k}}if(i=="MultiLineString")for(h=0;h<r;h++){f=t[h];e=f.length;for(o=0;o<e;o++){k=f[o];l=[g*k[0],m*(q-k[1])];if((o===
0||o==e-1)&&n(k,q))j=f[o?e-2:1],d=k[0]-j[0],i=k[1]-j[1],k=Math.sqrt(d*d+i*i),l=[l[0]+50*d/k,l[1]-50*i/k];o===0?(d=l,i=b,p.moveTo(d[0],d[1]),i&&a(d,i)):b?c(p,l):p.lineTo(l[0],l[1])}}}}();Kothic.textOnPath=function(){function a(a,g){if(!b[g])b[g]=a.measureText(g).width;return b[g]}function c(a,b){return[a[1]+0.5*Math.cos(a[0])*b,a[2]+0.5*Math.sin(a[0])*b]}function n(d,b,m,q){var q=q||0,i=a(d,b),b=a(d,b.charAt(0))*1.5,h=m[0],d=Math.abs(Math.cos(h)*i)+Math.abs(Math.sin(h)*b),b=Math.abs(Math.sin(h)*i)+Math.abs(Math.cos(h)*b);return[c(m,i+2*q),d,b,0]}function o(d,b,c,q){var i,h=0;for(i=0;i<=c.length;i++){if(d.checkPointWH.apply(d,n(b,c.charAt(i),q,h)))return!0;h+=a(b,c.charAt(i))}return!1}
function p(b,g,m){var q=g[4],i=c(g,a(b,q));b.save();b.translate(i[0],i[1]);b.rotate(g[0]);b[m?"strokeText":"fillText"](q,0,0);b.restore()}function t(a,b,c){var q=a.length,i,h,n,o,f,r,p,e=0;r=0;var j,k=!0;j=!1;c=c||3;for(f=1;f<q;f++){j&&(k=!1);r=a[f];p=a[f-1];i=r[0]-p[0];h=r[1]-p[1];r=Math.sqrt(i*i+h*h);!j&&e+r>=b&&(j=b-e,n=p[0]+i*j/r,o=p[1]+h*j/r,j=!0);if(j&&e+r>=b+c)return j=b+c-e,i=p[0]+i*j/r,h=p[1]+h*j/r,a=Math.atan2(h-o,i-n),k?[a,n,o,r-j]:[a,n,o,0];e+=r}}var b;return function(c,g,m,q,i){b={};
var h=c.measureText(m).width,B=m.length,w,f=g.length,r,A,e,j=0;for(e=1;e<f;e++)r=g[e],A=g[e-1],w=A[0]-r[0],r=A[1]-r[1],j+=Math.sqrt(w*w+r*r);w=j;if(!(w<h)){for(var k,l=0,y,u=!1,x,F=Math.PI/6;l<2;){r=l?a(c,m.charAt(0)):(w-h)/2;y=0;A=null;k=[];for(f=0;f<B;f++){j=m.charAt(f);x=a(c,j);e=t(g,r,x);if(r>=w||!e){l++;k=[];u&&(g.reverse(),u=!1);break}A||(A=e[0]);if(o(i,c,j,e)||Math.abs(A-e[0])>F)r+=x,f=-1,k=[],y=0;else{for(;x<e[3]&&f<B;){f++;j+=m.charAt(f);x=a(c,j);if(o(i,c,j,e)){f=0;r+=x;k=[];y=0;j=m.charAt(f);
x=a(c,j);e=t(g,r,x);break}if(x>=e[3]){f--;j=j.slice(0,-1);x=a(c,j);break}}if(e){if(e[0]>Math.PI/2||e[0]<-Math.PI/2)y+=j.length;A=e[0];e.push(j);k.push(e);r+=x}}}y>B/2&&(g.reverse(),k=[],u?(l++,g.reverse(),u=!1):u=!0);if(l>=2)return;if(k.length>0)break}g=k.length;for(f=0;q&&f<g;f++)p(c,k[f],!0);for(f=0;f<g;f++){e=k[f];p(c,e);q=i;m=c;h=e[4];B=e;e=void 0;for(e=w=0;e<=h.length;e++)q.addPointWH.apply(q,n(m,h.charAt(e),B,w)),w+=a(m,h.charAt(e))}}}}();
