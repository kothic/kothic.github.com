/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function b(f,u){return parseFloat(f.style["z-index"]||0)-parseFloat(u.style["z-index"]||0)}function i(f,u,a,d,o){var h=a.features,a=[],e,j,l,m,p,v;e=0;for(l=h.length;e<l;e++){p=m=h[e];v=d;var k=o,g=0;if(k)g=k.kothicId=k.kothicId||++C;var r=void 0,n=void 0,g=[MapCSS.currentStyle,g,JSON.stringify(p.properties),v,p.type].join(":");if(!t[g]){if(p.type=="Polygon"||p.type=="MultiPolygon")r="way",n="area";else if(p.type=="LineString"||p.type=="MultiLineString")r="way",n="line";else if(p.type==
"Point"||p.type=="MultiPoint")n=r="node";t[g]=MapCSS.restyle(p.properties,v,r,n);k&&k(t[g],p.properties,v,r,n)}p=t[g];for(j in p)if(p.hasOwnProperty(j)){v={};k=m;r=void 0;for(r in k)k.hasOwnProperty(r)&&(v[r]=k[r]);v.kothicId=e+1;v.style=p[j];a.push(v)}}a.sort(b);d=0;for(o=a.length;d<o;d++)j=a[d],h=parseFloat(j.properties.layer)||0,e=j.style["-x-mapnik-layer"],e=="top"&&(h=1E4),e=="bottom"&&(h=-1E4),h in f||(f[h]=[],u.push(h)),f[h].push(j);u.sort()}function h(f,a){for(var b in a)a.hasOwnProperty(b)&&
a[b]&&(f[b]=a[b])}function q(f,a,b){var d=a["fill-opacity"]||a.opacity;f.save();"fill-color"in a&&(h(f,{fillStyle:a["fill-color"],globalAlpha:d}),b());"fill-image"in a&&((a=MapCSS.getImage(a["fill-image"]))&&h(f,{fillStyle:f.createPattern(a,"repeat"),globalAlpha:d}),b());f.restore()}function g(f,a,b,d){d=MapCSS.restyle({},d,"canvas","canvas")["default"];f.save();q(f,d,function(){f.fillRect(-1,-1,a+1,b+1)});f.restore()}function n(f,a,b,d,t,h){var e=a.style,j=b&&b.style;p||(p=!0,f.beginPath());Kothic.path(f,
a,!1,!0,d,t,h);if(!b||!(j["fill-color"]===e["fill-color"]&&j["fill-image"]===e["fill-image"]&&j["fill-opacity"]===e["fill-opacity"]))f.save(),q(f,e,function(){f.fill()}),f.restore(),p=!1}function c(f,a,b){this.buffer=[];this.ctx=f;this.debugBoxes=a;this.debugChecks=b}function a(f,a,b,d,t,p,e,j){var l=a.style,m;a:switch(a.type){case "Point":m=a.coordinates;break;case "Polygon":m=a.reprpoint;break;case "LineString":m=a.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":case "MultiLineString":m=
void 0;break a}if(m){m=[d*m[0],t*(p-m[1])];var k;if(j){k=MapCSS.getImage(l["icon-image"]);if(!k)return;if(l["allow-overlap"]!="true"&&b.checkPointWH(m,k.width,k.height,a.kothicId))return}if(e){f.save();var e=l["text-halo-radius"]+2,g;g=l["font-family"];var n=l["font-size"];g=g||"";var n=n||9,c=g?g+", ":"";g=g.toLowerCase();var r=[];(g.indexOf("italic")!=-1||g.indexOf("oblique")!=-1)&&r.push("italic");g.indexOf("bold")!=-1&&(r.push("bold"),c+=g.replace("bold","")+", ");r.push(n+"px");c+=g.indexOf("serif")!=
-1?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif';r.push(c);g=r.join(" ");h(f,{lineWidth:e,font:g});e=l.text+"";n=f.measureText(e).width;c=n/e.length*2.5;r=l["text-offset"]||0;if(l["text-allow-overlap"]!="true"&&b.checkPointWH([m[0],m[1]+r],n,c,a.kothicId)){f.restore();return}g="text-halo-radius"in l;h(f,{fillStyle:l["text-color"]||"#000000",strokeStyle:l["text-halo-color"]||"#ffffff",globalAlpha:l["text-opacity"]||l.opacity,textAlign:"center",textBaseline:"middle"});if(a.type==
"Polygon"||a.type=="Point")g&&f.strokeText(e,m[0],m[1]+r),f.fillText(e,m[0],m[1]+r),d=parseFloat(l["-x-mapnik-min-distance"])||20,b.addPointWH([m[0],m[1]+r],n,c,d,a.kothicId);else if(a.type=="LineString"){for(var n=a.coordinates,c=[],r=0,i=n.length;r<i;r++)c.push([d*n[r][0],t*(p-n[r][1])]);Kothic.textOnPath(f,c,e,g,b)}f.restore()}j&&(f.drawImage(k,Math.floor(m[0]-k.width/2),Math.floor(m[1]-k.height/2)),d=parseFloat(l["-x-mapnik-min-distance"])||0,b.addPointWH(m,k.width,k.height,d,a.kothicId))}}var t=
{},p=!1,C=0,k={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round"};c.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,b,g,d,t){a=this.getBoxFromPoint(a,b,g,d,t);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var b=0,g=this.buffer.length,d;b<g;b++)if(d=this.buffer[b],!(a[4]&&
a[4]==d[4])&&d[0]<=a[2]&&d[1]<=a[3]&&d[2]>=a[0]&&d[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,b,g,d){return this.checkBox(this.getBoxFromPoint(a,b,g,0,d))},getBoxFromPoint:function(a,b,g,d,t){return[a[0]-b/2-d,a[1]-g/2-d,a[0]+b/2+d,a[1]+g/2+d,t]}};return function(b,t,q,d,o,C){var b=typeof b=="string"?document.getElementById(b):b,
e=b.getContext("2d"),j=b.width,l=b.height,m=t.granularity,A=j/m,v=l/m,z={},F=[],r=new c,G,K,L=+new Date,H,I,J;if(C)G=document.createElement("canvas"),G.width=j,G.height=l,K=e,e=G.getContext("2d");i(z,F,t,q,d);H=+new Date;h(e,k);var M=F.length,E,s,w,D,x,N;N=function(){r.addBox([0,0,j,0]);r.addBox([0,l,j,l]);r.addBox([j,0,j,l]);r.addBox([0,0,0,l]);for(E=M-1;E>=0;E--){w=z[F[E]];D=w.length;for(s=D-1;s>=0;s--)x=w[s].style,"icon-image"in x&&!x.text&&a(e,w[s],r,A,v,m,!1,!0);for(s=D-1;s>=0;s--)x=w[s].style,
x.text&&x["text-position"]=="line"&&a(e,w[s],r,A,v,m,!0,!1);for(s=D-1;s>=0;s--)x=w[s].style,x.text&&x["text-position"]!="line"&&!("icon-image"in x)&&a(e,w[s],r,A,v,m,!0,!1);for(s=D-1;s>=0;s--)x=w[s].style,"icon-image"in x&&x.text&&a(e,w[s],r,A,v,m,!0,!0)}J=+new Date;C&&K.drawImage(G,0,0);o({layersStyled:H-L,mapRendered:I-H,iconsAndTextRendered:J-I,total:J-L})};setTimeout(function(){g(e,j,l,q);for(E=0;E<M;E++){w=z[F[E]];D=w.length;for(s=0;s<D;s++)x=w[s].style,("fill-color"in x||"fill-image"in x)&&
n(e,w[s],w[s+1],A,v,m);e.lineCap="butt";for(s=0;s<D;s++)if("casing-width"in w[s].style){var a=e,b=w[s],d=w[s+1],f=A,t=v,k=m,c=b.style,o=d&&d.style,r=c["casing-dashes"]||c.dashes||!1;p||(p=!0,a.beginPath());Kothic.path(a,b,r,!1,f,t,k);if(!d||!(o.width===c.width&&o["casing-width"]===c["casing-width"]&&o["casing-color"]===c["casing-color"]&&o["casing-opacity"]===c["casing-opacity"]))a.save(),h(a,{lineWidth:2*c["casing-width"]+("width"in c?c.width:0),strokeStyle:c["casing-color"],lineCap:c["casing-linecap"]||
c.linecap,lineJoin:c["casing-linejoin"]||c.linejoin,globalAlpha:c["casing-opacity"]}),p=!1,a.stroke(),a.restore()}e.lineCap="round";for(s=0;s<D;s++)if("width"in w[s].style&&(a=e,b=w[s],d=w[s+1],f=A,t=v,k=m,c=b.style,o=d&&d.style,r=c.dashes,p||(p=!0,a.beginPath()),Kothic.path(a,b,r,!1,f,t,k),!d||!(o.width===c.width&&o.color===c.color&&o.opacity===c.opacity)))a.save(),h(a,{lineWidth:c.width,strokeStyle:c.color,lineCap:c.linecap,lineJoin:c.linejoin,globalAlpha:c.opacity}),p=!1,a.stroke(),a.restore();
I=+new Date}setTimeout(N,0)},0)}}();var MapCSS={styles:{},currentStyle:"",onError:function(){},onImagesLoad:function(){},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var b=0;b<arguments.length;b++)if(typeof arguments[b]!="undefined"&&arguments[b]!=="")return arguments[b];return""},e_num:function(b){return isNaN(parseFloat(b))?"":parseFloat(b)},e_str:function(b){return b},e_int:function(b){return parseInt(b,10)},e_tag:function(b,i){return i in b&&
b[i]!==null?b[i]:""},e_prop:function(b,i){return i in b&&b[i]!==null?b[i]:""},e_sqrt:function(b){return Math.sqrt(b)},e_boolean:function(b){return b=="0"||b=="false"||b===""?"false":"true"},e_boolean:function(b,i,h){return MapCSS.e_boolean(b)=="true"?i:h},e_metric:function(b){return/\d\s*mm$/.test(b)?1E3*parseInt(b,10):/\d\s*cm$/.test(b)?100*parseInt(b,10):/\d\s*dm$/.test(b)?10*parseInt(b,10):/\d\s*km$/.test(b)?0.0010*parseInt(b,10):/\d\s*in$/.test(b)?0.0254*parseInt(b,10):/\d\s*ft$/.test(b)?0.3048*
parseInt(b,10):parseInt(b,10)},e_zmetric:function(b){return MapCSS.metric(b)},loadStyle:function(b,i,h,q){MapCSS.styles[b]={restyle:i,images:h,external_images:q,textures:{}};if(!MapCSS.currentStyle)MapCSS.currentStyle=b},loadImages:function(b,i){var h=!i,q=!MapCSS.styles[b].external_images.length;if(q&&h)MapCSS.onImagesLoad();q||MapCSS._preloadExternalImages(b,function(){if((q=!0)&&h)MapCSS.onImagesLoad()});h||MapCSS._preloadSpriteImage(b,i,function(){h=!0;if(q&&h)MapCSS.onImagesLoad()})},_preloadSpriteImage:function(b,
i,h){var q=new Image;q.onload=function(){var g=MapCSS.styles[b].images,n;for(n in g)if(g.hasOwnProperty(n))g[n].sprite=q;h()};q.onerror=function(b){MapCSS.onError(b)};q.src=i},_preloadExternalImages:function(b,i){var h=MapCSS.styles[b].external_images;delete MapCSS.styles[b].external_images;for(var q=h.length,g=0,n=0;n<q;n++)(function(c){var a=new Image;a.onload=function(){g++;MapCSS.styles[b].images[c]={sprite:a,height:a.height,width:a.width,offset:0};g==q&&i()};a.onerror=function(){g++;g==q&&i()};
a.src=c})(h[n])},getImage:function(b){var i=MapCSS.styles[MapCSS.currentStyle],h=i.images[b];if(h.sprite){var q=document.createElement("canvas");q.width=h.width;q.height=h.height;q.getContext("2d").drawImage(h.sprite,0,h.offset,h.width,h.height,0,0,h.width,h.height);h=i.images[b]=q}return h},restyle:function(){return MapCSS.styles[MapCSS.currentStyle].restyle.apply(MapCSS,arguments)}};Kothic.path=function(){function b(b,h){q={pattern:h,seg:0,phs:0,x:b[0],y:b[1]}}function i(b,h){var c=q,a=h[0]-c.x,t=h[1]-c.y,p=Math.sqrt(a*a+t*t),i;b.save();b.translate(c.x,c.y);b.rotate(Math.atan2(t,a));b.moveTo(0,0);a=0;do{i=c.pattern[c.seg];a+=i-c.phs;t=a<p;if(!t)c.phs=i-(a-p),a=p;b[c.seg%2?"moveTo":"lineTo"](a,0);if(t)c.phs=0,c.seg=++c.seg%c.pattern.length}while(t);c.x=h[0];c.y=h[1];b.restore()}function h(b,h){return b[0]===0||b[0]==h||b[1]===0||b[1]==h}var q;return function(g,n,c,a,t,p,q){var k=
n.type,n=n.coordinates;k=="Polygon"&&(n=[n],k="MultiPolygon");k=="LineString"&&(n=[n],k="MultiLineString");var f,u,y,d,o=n.length,B,e,j,l,m;if(k=="MultiPolygon")for(f=0;f<o;f++){y=0;for(B=n[f].length;y<B;y++){d=n[f][y];e=d.length;j=d[0];for(u=0;u<=e;u++)l=d[u]||d[0],m=[t*l[0],p*(q-l[1])],u===0||!a&&h(l,q)&&h(j,q)?(j=c,g.moveTo(m[0],m[1]),j&&b(m,j)):a||!c?g.lineTo(m[0],m[1]):i(g,m),j=l}}if(k=="MultiLineString")for(f=0;f<o;f++){d=n[f];e=d.length;for(u=0;u<e;u++){l=d[u];m=[t*l[0],p*(q-l[1])];if((u===
0||u==e-1)&&h(l,q))j=d[u?e-2:1],a=l[0]-j[0],k=l[1]-j[1],l=Math.sqrt(a*a+k*k),m=[m[0]+10*a/l,m[1]-10*k/l];u===0?(a=m,k=c,g.moveTo(a[0],a[1]),k&&b(a,k)):c?i(g,m):g.lineTo(m[0],m[1])}}}}();Kothic.textOnPath=function(){function b(a,b){if(!c[b])c[b]=a.measureText(b).width;return c[b]}function i(a,b){return[a[1]+0.5*Math.cos(a[0])*b,a[2]+0.5*Math.sin(a[0])*b]}function h(a,c,h,g){var g=g||0,k=b(a,c),c=b(a,c.charAt(0))*1.5,f=h[0],a=Math.abs(Math.cos(f)*k)+Math.abs(Math.sin(f)*c),c=Math.abs(Math.sin(f)*k)+Math.abs(Math.cos(f)*c);return[i(h,k+2*g),a,c,0]}function q(a,c,g,n){var k,f=0;for(k=0;k<=g.length;k++){if(a.checkPointWH.apply(a,h(c,g.charAt(k),n,f)))return!0;f+=b(c,g.charAt(k))}return!1}
function g(a,c,h){var g=c[4],k=i(c,b(a,g));a.save();a.translate(k[0],k[1]);a.rotate(c[0]);a[h?"strokeText":"fillText"](g,0,0);a.restore()}function n(a,b,c){var h=a.length,g,f,n,q,d,o,i,e=0;o=0;var j,l=!0;gotxy=!1;c=c||3;for(d=1;d<h;d++){gotxy&&(l=!1);o=a[d];i=a[d-1];g=o[0]-i[0];f=o[1]-i[1];o=Math.sqrt(g*g+f*f);!gotxy&&e+o>=b&&(j=b-e,n=i[0]+g*j/o,q=i[1]+f*j/o,gotxy=!0);if(gotxy&&e+o>=b+c)return j=b+c-e,g=i[0]+g*j/o,f=i[1]+f*j/o,a=Math.atan2(f-q,g-n),l?[a,n,q,o-j]:[a,n,q,0];e+=o}}var c;return function(a,
i,p,C,k){c={};var f=a.measureText(p).width,u=p.length,y,d=i.length,o,B,e,j=0;for(e=1;e<d;e++)o=i[e],B=i[e-1],y=B[0]-o[0],o=B[1]-o[1],j+=Math.sqrt(y*y+o*o);y=j;if(!(y<f)){for(var l,m=0,A,v=!1,z,F=Math.PI/6;m<2;){o=m?b(a,p.charAt(0)):(y-f)/2;A=0;B=null;l=[];for(d=0;d<u;d++){j=p.charAt(d);z=b(a,j);e=n(i,o,z);if(o>=y||!e){m++;l=[];v&&(i.reverse(),v=!1);break}B||(B=e[0]);if(q(k,a,j,e)||Math.abs(B-e[0])>F)o+=z,d=-1,l=[],A=0;else{for(;z<e[3]&&d<u;){d++;j+=p.charAt(d);z=b(a,j);if(q(k,a,j,e)){d=0;o+=z;l=[];
A=0;j=p.charAt(d);z=b(a,j);e=n(i,o,z);break}if(z>=e[3]){d--;j=j.slice(0,-1);z=b(a,j);break}}if(e){if(e[0]>Math.PI/2||e[0]<-Math.PI/2)A+=j.length;B=e[0];e.push(j);l.push(e);o+=z}}}A>u/2&&(i.reverse(),l=[],v?(m++,i.reverse(),v=!1):v=!0);if(m>=2)return;if(l.length>0)break}i=l.length;for(d=0;C&&d<i;d++)g(a,l[d],!0);for(d=0;d<i;d++){e=l[d];g(a,e);C=k;p=a;f=e[4];u=e;e=void 0;for(e=y=0;e<=f.length;e++)C.addPointWH.apply(C,h(p,f.charAt(e),u,y)),y+=b(p,f.charAt(e))}}}}();
