/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(c,k){return parseFloat(c.style["z-index"]||0)-parseFloat(k.style["z-index"]||0)}function q(c,k,b,f,d){var o=b.features,b=[],e,s,l,j,v,r;e=0;for(l=o.length;e<l;e++){v=j=o[e];r=f;var i=d,m=0;if(i)m=i.kothicId=i.kothicId||++g;var n=void 0,h=void 0,m=[MapCSS.currentStyle,m,JSON.stringify(v.properties),r,v.type].join(":");if(!p[m]){if(v.type=="Polygon"||v.type=="MultiPolygon")n="way",h="area";else if(v.type=="LineString"||v.type=="MultiLineString")n="way",h="line";else if(v.type==
"Point"||v.type=="MultiPoint")h=n="node";p[m]=MapCSS.restyle(v.properties,r,n,h);i&&i(p[m],v.properties,r,n,h)}v=p[m];for(s in v)if(v.hasOwnProperty(s)){r={};i=j;n=void 0;for(n in i)i.hasOwnProperty(n)&&(r[n]=i[n]);r.kothicId=e+1;r.style=v[s];b.push(r)}}b.sort(a);f=0;for(d=b.length;f<d;f++)s=b[f],o=parseFloat(s.properties.layer)||0,e=s.style["-x-mapnik-layer"],e=="top"&&(o=1E4),e=="bottom"&&(o=-1E4),o in c||(c[o]=[],k.push(o)),c[o].push(s);k.sort()}function d(c,k){for(var b in k)k.hasOwnProperty(b)&&
k[b]&&(c[b]=k[b])}function u(c,k,b){var a=k["fill-opacity"]||k.opacity;c.save();"fill-color"in k&&(d(c,{fillStyle:k["fill-color"],globalAlpha:a}),b());"fill-image"in k&&((k=MapCSS.getImage(k["fill-image"]))&&d(c,{fillStyle:c.createPattern(k,"repeat"),globalAlpha:a}),b());c.restore()}function m(c,b,a,f){f=MapCSS.restyle({},f,"canvas","canvas")["default"];c.save();u(c,f,function(){c.fillRect(-1,-1,b+1,a+1)});c.restore()}function h(c,b,a,f,p,i){var e=b.style,d=a&&a.style;o||(o=!0,c.beginPath());Kothic.path(c,
b,!1,!0,f,p,i);if(!a||!(d["fill-color"]===e["fill-color"]&&d["fill-image"]===e["fill-image"]&&d["fill-opacity"]===e["fill-opacity"]))c.save(),u(c,e,function(){c.fill()}),c.restore(),o=!1}function z(c,b,a){this.buffer=[];this.ctx=c;this.debugBoxes=b;this.debugChecks=a}function b(c,b,a,f,p,i,e,o){var l=b.style,j;a:switch(b.type){case "Point":j=b.coordinates;break;case "Polygon":j=b.reprpoint;break;case "LineString":j=b.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":case "MultiLineString":j=
void 0;break a}if(j){j=[f*j[0],p*(i-j[1])];var m;if(o){m=MapCSS.getImage(l["icon-image"]);if(!m)return;if(l["allow-overlap"]!="true"&&a.checkPointWH(j,m.width,m.height,b.kothicId))return}if(e){c.save();var e=l["text-halo-radius"]+2,r;r=l["font-family"];var h=l["font-size"];r=r||"";var h=h||9,g=r?r+", ":"";r=r.toLowerCase();var n=[];(r.indexOf("italic")!=-1||r.indexOf("oblique")!=-1)&&n.push("italic");r.indexOf("bold")!=-1&&(n.push("bold"),g+=r.replace("bold","")+", ");n.push(h+"px");g+=r.indexOf("serif")!=
-1?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif';n.push(g);r=n.join(" ");d(c,{lineWidth:e,font:r});e=l.text+"";h=c.measureText(e).width;g=h/e.length*2.5;n=l["text-offset"]||0;if(l["text-allow-overlap"]!="true"&&a.checkPointWH([j[0],j[1]+n],h,g,b.kothicId)){c.restore();return}r="text-halo-radius"in l;d(c,{fillStyle:l["text-color"]||"#000000",strokeStyle:l["text-halo-color"]||"#ffffff",globalAlpha:l["text-opacity"]||l.opacity,textAlign:"center",textBaseline:"middle"});if(b.type==
"Polygon"||b.type=="Point")r&&c.strokeText(e,j[0],j[1]+n),c.fillText(e,j[0],j[1]+n),f=parseFloat(l["-x-mapnik-min-distance"])||20,a.addPointWH([j[0],j[1]+n],h,g,f,b.kothicId);else if(b.type=="LineString"){for(var h=b.coordinates,g=[],n=0,z=h.length;n<z;n++)g.push([f*h[n][0],p*(i-h[n][1])]);Kothic.textOnPath(c,g,e,r,a)}c.restore()}o&&(c.drawImage(m,Math.floor(j[0]-m.width/2),Math.floor(j[1]-m.height/2)),f=parseFloat(l["-x-mapnik-min-distance"])||0,a.addPointWH(j,m.width,m.height,f,b.kothicId))}}var p=
{},o=!1,g=0,i={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round"};z.prototype={addBox:function(c){this.buffer.push(c)},addPointWH:function(c,b,a,f,p){c=this.getBoxFromPoint(c,b,a,f,p);this.buffer.push(c);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(c[0],c[1],c[2]-c[0],c[3]-c[1]),this.ctx.restore()},checkBox:function(c){for(var b=0,a=this.buffer.length,f;b<a;b++)if(f=this.buffer[b],!(c[4]&&
c[4]==f[4])&&f[0]<=c[2]&&f[1]<=c[3]&&f[2]>=c[0]&&f[3]>=c[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(c[0],c[1],c[2]-c[0],c[3]-c[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(b,a,p,f){return this.checkBox(this.getBoxFromPoint(b,a,p,0,f))},getBoxFromPoint:function(b,a,p,f,m){return[b[0]-a/2-f,b[1]-p/2-f,b[0]+a/2+f,b[1]+p/2+f,m]}};return function(c,a,p,f,g,u){var c=typeof c=="string"?document.getElementById(c):c,
e=c.getContext("2d"),s=c.width,l=c.height,j=a.granularity,v=s/j,r=l/j,B={},E=[],n=new z,F,K,L=+new Date,H,I,J;if(u)F=document.createElement("canvas"),F.width=s,F.height=l,K=e,e=F.getContext("2d");q(B,E,a,p,f);H=+new Date;d(e,i);var M=E.length,D,t,w,C,y,N;N=function(){n.addBox([0,0,s,0]);n.addBox([0,l,s,l]);n.addBox([s,0,s,l]);n.addBox([0,0,0,l]);for(D=M-1;D>=0;D--){w=B[E[D]];C=w.length;for(t=C-1;t>=0;t--)y=w[t].style,"icon-image"in y&&!y.text&&b(e,w[t],n,v,r,j,!1,!0);for(t=C-1;t>=0;t--)y=w[t].style,
y.text&&y["text-position"]=="line"&&b(e,w[t],n,v,r,j,!0,!1);for(t=C-1;t>=0;t--)y=w[t].style,y.text&&y["text-position"]!="line"&&!("icon-image"in y)&&b(e,w[t],n,v,r,j,!0,!1);for(t=C-1;t>=0;t--)y=w[t].style,"icon-image"in y&&y.text&&b(e,w[t],n,v,r,j,!0,!0)}J=+new Date;u&&K.drawImage(F,0,0);g({layersStyled:H-L,mapRendered:I-H,iconsAndTextRendered:J-I,total:J-L})};setTimeout(function(){m(e,s,l,p);for(D=0;D<M;D++){w=B[E[D]];C=w.length;for(t=0;t<C;t++)y=w[t].style,("fill-color"in y||"fill-image"in y)&&
h(e,w[t],w[t+1],v,r,j);e.lineCap="butt";for(t=0;t<C;t++)if("casing-width"in w[t].style){var b=e,a=w[t],c=w[t+1],f=v,i=r,k=j,g=a.style,n=c&&c.style,z=g["casing-dashes"]||g.dashes||!1;o||(o=!0,b.beginPath());Kothic.path(b,a,z,!1,f,i,k);if(!c||!(n.width===g.width&&n["casing-width"]===g["casing-width"]&&n["casing-color"]===g["casing-color"]&&n["casing-opacity"]===g["casing-opacity"]))b.save(),d(b,{lineWidth:2*g["casing-width"]+("width"in g?g.width:0),strokeStyle:g["casing-color"],lineCap:g["casing-linecap"]||
g.linecap,lineJoin:g["casing-linejoin"]||g.linejoin,globalAlpha:g["casing-opacity"]}),o=!1,b.stroke(),b.restore()}e.lineCap="round";for(t=0;t<C;t++)if("width"in w[t].style&&(b=e,a=w[t],c=w[t+1],f=v,i=r,k=j,g=a.style,n=c&&c.style,z=g.dashes,o||(o=!0,b.beginPath()),Kothic.path(b,a,z,!1,f,i,k),!c||!(n.width===g.width&&n.color===g.color&&n.opacity===g.opacity)))b.save(),d(b,{lineWidth:g.width,strokeStyle:g.color,lineCap:g.linecap,lineJoin:g.linejoin,globalAlpha:g.opacity}),o=!1,b.stroke(),b.restore();
I=+new Date}setTimeout(N,0)},0)}}();var MapCSS={styles:{},currentStyle:"",onError:function(){},onImagesLoad:function(){},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,q){return q in a&&
a[q]!==null?a[q]:""},e_prop:function(a,q){return q in a&&a[q]!==null?a[q]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,q,d){return MapCSS.e_boolean(a)=="true"?q:d},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,q,d,u){MapCSS.styles[a]={restyle:q,images:d,external_images:u,textures:{}};if(!MapCSS.currentStyle)MapCSS.currentStyle=a},loadImages:function(a,q){var d=!q,u=!MapCSS.styles[a].external_images.length;if(u&&d)MapCSS.onImagesLoad();u||MapCSS._preloadExternalImages(a,function(){if((u=!0)&&d)MapCSS.onImagesLoad()});d||MapCSS._preloadSpriteImage(a,q,function(){d=!0;if(u&&d)MapCSS.onImagesLoad()})},_preloadSpriteImage:function(a,
q,d){var u=new Image;u.onload=function(){var m=MapCSS.styles[a].images,h;for(h in m)if(m.hasOwnProperty(h))m[h].sprite=u;d()};u.onerror=function(a){MapCSS.onError(a)};u.src=q},_preloadExternalImages:function(a,q){var d=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var u=d.length,m=0,h=0;h<u;h++)(function(h){var b=new Image;b.onload=function(){m++;MapCSS.styles[a].images[h]={sprite:b,height:b.height,width:b.width,offset:0};m==u&&q()};b.onerror=function(){m++;m==u&&q()};
b.src=h})(d[h])},getImage:function(a){var q=MapCSS.styles[MapCSS.currentStyle],d=q.images[a];if(d.sprite){var u=document.createElement("canvas");u.width=d.width;u.height=d.height;u.getContext("2d").drawImage(d.sprite,0,d.offset,d.width,d.height,0,0,d.width,d.height);d=q.images[a]=u}return d},restyle:function(){return MapCSS.styles[MapCSS.currentStyle].restyle.apply(MapCSS,arguments)}};Kothic.path=function(){function a(a,h){u={pattern:h,seg:0,phs:0,x:a[0],y:a[1]}}function q(a,h){var d=u,b=h[0]-d.x,p=h[1]-d.y,o=Math.sqrt(b*b+p*p),g;a.save();a.translate(d.x,d.y);a.rotate(Math.atan2(p,b));a.moveTo(0,0);b=0;do{g=d.pattern[d.seg];b+=g-d.phs;p=b<o;if(!p)d.phs=g-(b-o),b=o;a[d.seg%2?"moveTo":"lineTo"](b,0);if(p)d.phs=0,d.seg=++d.seg%d.pattern.length}while(p);d.x=h[0];d.y=h[1];a.restore()}function d(a,d){return a[0]===0||a[0]==d||a[1]===0||a[1]==d}var u;return function(m,h,u,b,p,o,g){var i=
h.type,h=h.coordinates;i=="Polygon"&&(h=[h],i="MultiPolygon");i=="LineString"&&(h=[h],i="MultiLineString");var c,k,G,f,x=h.length,A,e,s,l,j;if(i=="MultiPolygon")for(c=0;c<x;c++){G=0;for(A=h[c].length;G<A;G++){f=h[c][G];e=f.length;s=f[0];for(k=0;k<=e;k++)l=f[k]||f[0],j=[p*l[0],o*(g-l[1])],k===0||!b&&d(l,g)&&d(s,g)?(s=u,m.moveTo(j[0],j[1]),s&&a(j,s)):b||!u?m.lineTo(j[0],j[1]):q(m,j),s=l}}if(i=="MultiLineString")for(c=0;c<x;c++){f=h[c];e=f.length;for(k=0;k<e;k++){l=f[k];j=[p*l[0],o*(g-l[1])];if((k===
0||k==e-1)&&d(l,g))s=f[k?e-2:1],b=l[0]-s[0],i=l[1]-s[1],l=Math.sqrt(b*b+i*i),j=[j[0]+10*b/l,j[1]-10*i/l];k===0?(b=j,i=u,m.moveTo(b[0],b[1]),i&&a(b,i)):u?q(m,j):m.lineTo(j[0],j[1])}}}}();Kothic.textOnPath=function(){function a(b,a){if(!z[a])z[a]=b.measureText(a).width;return z[a]}function q(a,d){return[a[1]+0.5*Math.cos(a[0])*d,a[2]+0.5*Math.sin(a[0])*d]}function d(b,d,h,g){var g=g||0,i=a(b,d),d=a(b,d.charAt(0))*1.5,c=h[0],b=Math.abs(Math.cos(c)*i)+Math.abs(Math.sin(c)*d),d=Math.abs(Math.sin(c)*i)+Math.abs(Math.cos(c)*d);return[q(h,i+2*g),b,d,0]}function u(b,h,o,g){var i,c=0;for(i=0;i<=o.length;i++){if(b.checkPointWH.apply(b,d(h,o.charAt(i),g,c)))return!0;c+=a(h,o.charAt(i))}return!1}
function m(b,d,h){var g=d[4],i=q(d,a(b,g));b.save();b.translate(Math.floor(i[0]),Math.floor(i[1]));b.rotate(d[0]);b[h?"strokeText":"fillText"](g,0,0);b.restore()}function h(a,d){var h=a.length,g,i,c,k,m,f=0;m=0;for(k=1;k<h;k++){m=a[k];c=a[k-1];g=m[0]-c[0];i=m[1]-c[1];m=Math.sqrt(g*g+i*i);if(f+m>=d)return k=d-f,h=c[0]+g*k/m,c=c[1]+i*k/m,g=Math.atan2(i,g),[g,h,c,m-k];f+=m}}var z;return function(b,p,o,g,i){z={};var c=b.measureText(o).width,k=o.length,q,f=p.length,x,A,e,s=0;for(e=1;e<f;e++)x=p[e],A=p[e-
1],q=A[0]-x[0],x=A[1]-x[1],s+=Math.sqrt(q*q+x*x);q=s;if(!(q<c)){for(var l,j=0,v,r=!1,B,E=Math.PI/6;j<2;){x=j?a(b,o.charAt(0)):(q-c)/2;v=0;A=null;l=[];for(f=0;f<k;f++){e=h(p,x);if(x>=q||!e){j++;l=[];r&&(p.reverse(),r=!1);break}A||(A=e[0]);s=o.charAt(f);B=a(b,s);if(u(i,b,s,e)||Math.abs(A-e[0])>E)x+=B,f=-1,l=[],v=0;else{for(;B<e[3]&&f<k;)if(f++,s+=o.charAt(f),B=a(b,s),u(i,b,s,e)||Math.abs(A-e[0])>E){f=0;x+=B;l=[];v=0;s=o.charAt(f);B=a(b,s);e=h(p,x);break}if(e){if(e[0]>Math.PI/2||e[0]<-Math.PI/2)v+=s.length;
A=e[0];e.push(s);l.push(e);x+=B}}}v>k/2&&(p.reverse(),l=[],r?(j++,p.reverse(),r=!1):r=!0);if(j>=2)return;if(l.length>0)break}p=l.length;for(f=0;g&&f<p;f++)m(b,l[f],!0);for(f=0;f<p;f++){e=l[f];m(b,e);g=i;o=b;c=e[4];k=e;e=void 0;for(e=q=0;e<=c.length;e++)g.addPointWH.apply(g,d(o,c.charAt(e),k,q)),q+=a(o,c.charAt(e))}}}}();
