/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(t,a){return parseFloat(t.style["z-index"]||0)-parseFloat(a.style["z-index"]||0)}function b(t,w,g,c,e){var i=g.features,g=[],f,o,u,h,m,q;f=0;for(u=i.length;f<u;f++){m=h=i[f];q=c;var r=e,d=0;if(r)d=r.kothicId=r.kothicId||++k;var b=void 0,p=void 0,d=[d,JSON.stringify(m.properties),q,m.type].join(":");if(!j[d]){if(m.type=="Polygon"||m.type=="MultiPolygon")b="way",p="area";else if(m.type=="LineString"||m.type=="MultiLineString")b="way",p="line";else if(m.type=="Point"||
m.type=="MultiPoint")p=b="node";j[d]=j[d]||{};j[d]=MapCSS.restyle(j[d],m.properties,q,b,p);r&&r(j[d],m.properties,q,b,p)}m=j[d];for(o in m)if(m.hasOwnProperty(o)){q={};r=h;b=void 0;for(b in r)r.hasOwnProperty(b)&&(q[b]=r[b]);q.kothicId=f+1;q.style=m[o];g.push(q)}}g.sort(a);c=0;for(e=g.length;c<e;c++)o=g[c],i=parseFloat(o.properties.layer)||0,f=o.style["-x-mapnik-layer"],f=="top"&&(i=1E4),f=="bottom"&&(i=-1E4),i in t||(t[i]=[],w.push(i)),t[i].push(o);w.sort()}function p(t,a){for(var g in a)a.hasOwnProperty(g)&&
h[g]!=a[g]&&(t[g]=a[g],h[g]=a[g])}function l(t,a,g){var e=a["fill-opacity"]||a.opacity;"fill-color"in a&&(p(t,{fillStyle:a["fill-color"]||"#000000",globalAlpha:e||1}),g());"fill-image"in a&&((a=MapCSS.getImage(a["fill-image"]))&&p(t,{fillStyle:t.createPattern(a,"repeat"),globalAlpha:e||1}),g())}function r(a,e,g,c){var j={};MapCSS.restyle(j,{},c,"canvas","canvas");l(a,j,function(){a.fillRect(-1,-1,e+1,g+1)})}function x(a,e,g,c,j,i){var f=e.style,o=g&&g.style;m||(m=!0,a.beginPath());Kothic.path(a,e,
!1,!0,c,j,i);if(!g||!(o["fill-color"]==f["fill-color"]&&o["fill-image"]==f["fill-image"]&&o["fill-opacity"]==f["fill-opacity"]))l(a,f,function(){a.fill()}),m=!1}function d(a,e,g){this.buffer=[];this.ctx=a;this.debugBoxes=e;this.debugChecks=g}function e(a,e,g,c,j,i,f,m){var d=e.style,b;a:switch(e.type){case "Point":b=e.coordinates;break;case "Polygon":b=e.reprpoint;break;case "LineString":b=e.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":b=e.reprpoint;break;case "MultiLineString":b=
void 0;break a}if(b){b=[c*b[0],j*(i-b[1])];var r;if(m){r=MapCSS.getImage(d["icon-image"]);if(!r)return;if(d["allow-overlap"]!="true"&&g.checkPointWH(b,r.width,r.height,e.kothicId))return}if(f){var f=d["text-halo-radius"]*2,q;q=d["font-family"];var n=d["font-size"];q=q||"";var n=n||9,x=q?q+", ":"";q=q.toLowerCase();var k=[];(q.indexOf("italic")!=-1||q.indexOf("oblique")!=-1)&&k.push("italic");q.indexOf("bold")!=-1&&(k.push("bold"),x+=q.replace("bold","")+", ");k.push(n+"px");x+=q.indexOf("serif")!=
-1?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif';k.push(x);q=k.join(" ");p(a,{lineWidth:f,font:q});f=d.text+"";n=a.measureText(f).width;x=n/f.length*2.5;k=d["text-offset"]||0;q="text-halo-radius"in d;p(a,{fillStyle:d["text-color"]||"#000000",strokeStyle:d["text-halo-color"]||"#ffffff",globalAlpha:d["text-opacity"]||d.opacity||1,textAlign:"center",textBaseline:"middle"});if(e.type=="Polygon"||e.type=="Point"){if(d["text-allow-overlap"]!="true"&&g.checkPointWH([b[0],b[1]+k],n,x,
e.kothicId))return;q&&a.strokeText(f,b[0],b[1]+k);a.fillText(f,b[0],b[1]+k);c=d["-x-mapnik-min-distance"]||20;g.addPointWH([b[0],b[1]+k],n,x,c,e.kothicId)}else if(e.type=="LineString"){for(var n=e.coordinates,x=[],k=0,l=n.length;k<l;k++)x.push([c*n[k][0],j*(i-n[k][1])]);Kothic.textOnPath(a,x,f,q,g);delete h.textAlign;delete h.strokeStyle;delete h.textBaseline}}m&&(a.drawImage(r,Math.floor(b[0]-r.width/2),Math.floor(b[1]-r.height/2)),c=parseFloat(d["-x-mapnik-min-distance"])||0,g.addPointWH(b,r.width,
r.height,c,e.kothicId))}}var j={},m=!1,k=0,h={},n={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round",textAlign:"center",textBaseline:"middle"};d.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,e,g,b,j){a=this.getBoxFromPoint(a,e,g,b,j);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var e=
0,g=this.buffer.length,b;e<g;e++)if(b=this.buffer[e],!(a[4]&&a[4]==b[4])&&b[0]<=a[2]&&b[1]<=a[3]&&b[2]>=a[0]&&b[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,e,b,j){return this.checkBox(this.getBoxFromPoint(a,e,b,0,j))},getBoxFromPoint:function(a,e,b,j,d){return[a[0]-e/2-j,a[1]-b/2-j,a[0]+e/2+j,a[1]+b/2+j,d]}};return function(a,j,g,
c,h,i){var a=typeof a=="string"?document.getElementById(a):a,f=a.getContext("2d"),o=a.width,k=a.height,l=j.granularity,y=o/l,q=k/l,F={},H=[],D=new d,G,L,M=+new Date,I,J,K;if(i)G=document.createElement("canvas"),G.width=o,G.height=k,L=f,f=G.getContext("2d");b(F,H,j,g,c);I=+new Date;p(f,n);var N=H.length,B,s,v,C,z,O;O=function(){D.addBox([0,0,o,0]);D.addBox([0,k,o,k]);D.addBox([o,0,o,k]);D.addBox([0,0,0,k]);var a=f.strokeText&&f.fillText&&f.measureText;for(B=N-1;B>=0;B--){v=F[H[B]];C=v.length;for(s=
C-1;s>=0;s--)z=v[s].style,"icon-image"in z&&!z.text&&e(f,v[s],D,y,q,l,!1,!0);for(s=C-1;a&&s>=0;s--)z=v[s].style,z.text&&!("icon-image"in z)&&e(f,v[s],D,y,q,l,!0,!1);for(s=C-1;s>=0;s--)z=v[s].style,"icon-image"in z&&z.text&&e(f,v[s],D,y,q,l,a,!0)}K=+new Date;i&&L.drawImage(G,0,0);h({layersStyled:I-M,mapRendered:J-I,iconsAndTextRendered:K-J,total:K-M})};setTimeout(function(){r(f,o,k,g);for(B=0;B<N;B++){v=F[H[B]];C=v.length;for(s=0;s<C;s++)z=v[s].style,("fill-color"in z||"fill-image"in z)&&x(f,v[s],
v[s+1],y,q,l);f.lineCap="butt";for(s=0;s<C;s++)if("casing-width"in v[s].style){var a=f,e=v[s],b=v[s+1],j=y,d=q,i=l,c=e.style,h=b&&b.style,n=c["casing-dashes"]||c.dashes||!1;m||(m=!0,a.beginPath());Kothic.path(a,e,n,!1,j,d,i);if(!b||!(h.width==c.width&&h["casing-width"]==c["casing-width"]&&h["casing-color"]==c["casing-color"]&&(h["casing-dashes"]||h.dashes||!1)==(c["casing-dashes"]||c.dashes||!1)&&(h["casing-linecap"]||h.linecap||"butt")==(c["casing-linecap"]||c.linecap||"butt")&&(h["casing-linejoin"]||
h.linejoin||"round")==(c["casing-linejoin"]||c.linejoin||"round")&&(h["casing-opacity"]||h.opacity)==(c.opacity||c["casing-opacity"])))p(a,{lineWidth:2*c["casing-width"]+("width"in c?c.width:0),strokeStyle:c["casing-color"]||"#000000",lineCap:c["casing-linecap"]||c.linecap||"butt",lineJoin:c["casing-linejoin"]||c.linejoin||"round",globalAlpha:c["casing-opacity"]||1}),m=!1,a.stroke()}f.lineCap="round";for(s=0;s<C;s++)if(v[s].style.width&&(a=f,e=v[s],b=v[s+1],j=y,d=q,i=l,c=e.style,h=b&&b.style,n=c.dashes,
m||(m=!0,a.beginPath()),Kothic.path(a,e,n,!1,j,d,i),!b||!((h.width||1)==(c.width||1)&&(h.color||"#000000")==(c.color||"#000000")&&h.linecap==c.linecap&&h.linejoin==c.linejoin&&h.image==c.image&&h.opacity==c.opacity))){if("color"in c||not("image"in c))p(a,{lineWidth:c.width||1,strokeStyle:c.color||"#000000",lineCap:c.linecap||"round",lineJoin:c.linejoin||"round",globalAlpha:c.opacity||1}),a.stroke();if("image"in c&&(image=MapCSS.getImage(c.image)))p(a,{strokeStyle:a.createPattern(image,"repeat")||
"#000000",lineWidth:c.width||1,lineCap:c.linecap||"round",lineJoin:c.linejoin||"round",globalAlpha:c.opacity||1}),a.stroke();m=!1}J=+new Date}setTimeout(O,0)},0)}}();var MapCSS={styles:{},currentStyles:[],onError:function(){},onImagesLoad:function(){},images:{},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,b){return b in
a&&a[b]!==null?a[b]:""},e_prop:function(a,b){return b in a&&a[b]!==null?a[b]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,b,p){return MapCSS.e_boolean(a)=="true"?b:p},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,b,p,l){MapCSS.styles[a]={restyle:b,images:p,external_images:l,textures:{},sprite_loaded:!p,external_images_loaded:!l.length};MapCSS.currentStyles.push(a)},_onImagesLoad:function(a){if(MapCSS.styles[a].external_images_loaded&&MapCSS.styles[a].sprite_loaded)MapCSS.onImagesLoad()},preloadSpriteImage:function(a,b){var p=MapCSS.styles[a].images;delete MapCSS.styles[a].images;var l=new Image;l.onload=function(){for(var b in p)if(p.hasOwnProperty(b))p[b].sprite=
l,MapCSS.images[b]=p[b];MapCSS.styles[a].sprite_loaded=!0;MapCSS._onImagesLoad(a)};l.onerror=function(a){MapCSS.onError(a)};l.src=b},preloadExternalImages:function(a){var b=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var p=b.length,l=0,r=0;r<p;r++)(function(b){var d=new Image;d.onload=function(){l++;MapCSS.images[b]={sprite:d,height:d.height,width:d.width,offset:0};if(l==p)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};d.onerror=function(){l++;
if(l==p)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};d.src=b})(b[r])},getImage:function(a){var b=MapCSS.images[a];if(b.sprite){var p=document.createElement("canvas");p.width=b.width;p.height=b.height;p.getContext("2d").drawImage(b.sprite,0,b.offset,b.width,b.height,0,0,b.width,b.height);b=MapCSS.images[a]=p}return b},restyle:function(a,b,p,l,r){for(var x,d=0;d<MapCSS.currentStyles.length;d++)x=MapCSS.currentStyles[d],a=MapCSS.styles[x].restyle(a,b,p,l,r);return a}};Kothic.path=function(){function a(a,b){l={pattern:b,seg:0,phs:0,x:a[0],y:a[1]}}function b(a,b){var d=l,e=b[0]-d.x,j=b[1]-d.y,m=Math.sqrt(e*e+j*j),k;a.save();a.translate(d.x,d.y);a.rotate(Math.atan2(j,e));a.moveTo(0,0);e=0;do{k=d.pattern[d.seg];e+=k-d.phs;j=e<m;if(!j)d.phs=k-(e-m),e=m;a[d.seg%2?"moveTo":"lineTo"](e,0);if(j)d.phs=0,d.seg=++d.seg%d.pattern.length}while(j);d.x=b[0];d.y=b[1];a.restore()}function p(a,b){return a[0]===0||a[0]==b||a[1]===0||a[1]==b}var l;return function(r,l,d,e,j,m,k){var h=
l.type,l=l.coordinates;h=="Polygon"&&(l=[l],h="MultiPolygon");h=="LineString"&&(l=[l],h="MultiLineString");var n,t,w,g,c=l.length,A,i,f,o,u;if(h=="MultiPolygon")for(n=0;n<c;n++){w=0;for(A=l[n].length;w<A;w++){g=l[n][w];i=g.length;f=g[0];for(t=0;t<=i;t++)o=g[t]||g[0],u=[j*o[0],m*(k-o[1])],t===0||!e&&p(o,k)&&p(f,k)?(f=d,r.moveTo(u[0],u[1]),f&&a(u,f)):e||!d?r.lineTo(u[0],u[1]):b(r,u),f=o}}if(h=="MultiLineString")for(n=0;n<c;n++){g=l[n];i=g.length;for(t=0;t<i;t++){o=g[t];u=[j*o[0],m*(k-o[1])];if((t===
0||t==i-1)&&p(o,k))f=g[t?i-2:1],e=o[0]-f[0],h=o[1]-f[1],o=Math.sqrt(e*e+h*h),u=[u[0]+50*e/o,u[1]-50*h/o];t===0?(e=u,h=d,r.moveTo(e[0],e[1]),h&&a(e,h)):d?b(r,u):r.lineTo(u[0],u[1])}}}}();Kothic.textOnPath=function(){function a(a,b){if(!d[b])d[b]=a.measureText(b).width;return d[b]}function b(a,b){return[a[1]+0.5*Math.cos(a[0])*b,a[2]+0.5*Math.sin(a[0])*b]}function p(e,j,d,k){var k=k||0,h=a(e,j),j=a(e,j.charAt(0))*1.5,n=d[0],e=Math.abs(Math.cos(n)*h)+Math.abs(Math.sin(n)*j),j=Math.abs(Math.sin(n)*h)+Math.abs(Math.cos(n)*j);return[b(d,h+2*k),e,j,0]}function l(b,d,m,k){var h,n=0;for(h=0;h<=m.length;h++){if(b.checkPointWH.apply(b,p(d,m.charAt(h),k,n)))return!0;n+=a(d,m.charAt(h))}return!1}
function r(e,d,m){var k=d[4],h=b(d,a(e,k));e.save();e.translate(h[0],h[1]);e.rotate(d[0]);e[m?"strokeText":"fillText"](k,0,0);e.restore()}function x(a,b,d){var k=a.length,h,n,l,p,g,c,r,i=0;c=0;var f,o=!0;f=!1;d=d||3;for(g=1;g<k;g++){f&&(o=!1);c=a[g];r=a[g-1];h=c[0]-r[0];n=c[1]-r[1];c=Math.sqrt(h*h+n*n);!f&&i+c>=b&&(f=b-i,l=r[0]+h*f/c,p=r[1]+n*f/c,f=!0);if(f&&i+c>=b+d)return f=b+d-i,h=r[0]+h*f/c,n=r[1]+n*f/c,a=Math.atan2(n-p,h-l),o?[a,l,p,c-f]:[a,l,p,0];i+=c}}var d;return function(b,j,m,k,h){d={};
var n=b.measureText(m).width,t=m.length,w,g=j.length,c,A,i,f=0;for(i=1;i<g;i++)c=j[i],A=j[i-1],w=A[0]-c[0],c=A[1]-c[1],f+=Math.sqrt(w*w+c*c);w=f;if(!(w<n)){for(var o,u=0,E,y=!1,q,F=Math.PI/6;u<2;){c=u?a(b,m.charAt(0)):(w-n)/2;E=0;A=null;o=[];for(g=0;g<t;g++){f=m.charAt(g);q=a(b,f);i=x(j,c,q);if(c>=w||!i){u++;o=[];y&&(j.reverse(),y=!1);break}A||(A=i[0]);if(l(h,b,f,i)||Math.abs(A-i[0])>F)c+=q,g=-1,o=[],E=0;else{for(;q<i[3]&&g<t;){g++;f+=m.charAt(g);q=a(b,f);if(l(h,b,f,i)){g=0;c+=q;o=[];E=0;f=m.charAt(g);
q=a(b,f);i=x(j,c,q);break}if(q>=i[3]){g--;f=f.slice(0,-1);q=a(b,f);break}}if(i){if(i[0]>Math.PI/2||i[0]<-Math.PI/2)E+=f.length;A=i[0];i.push(f);o.push(i);c+=q}}}E>t/2&&(j.reverse(),o=[],y?(u++,j.reverse(),y=!1):y=!0);if(u>=2)return;if(o.length>0)break}j=o.length;for(g=0;k&&g<j;g++)r(b,o[g],!0);for(g=0;g<j;g++){i=o[g];r(b,i);k=h;m=b;n=i[4];t=i;i=void 0;for(i=w=0;i<=n.length;i++)k.addPointWH.apply(k,p(m,n.charAt(i),t,w)),w+=a(m,n.charAt(i))}}}}();
