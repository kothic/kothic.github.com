<!doctype html>
<html>
<head>
	<title>A canvas Map of Minsk</title>
	
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="leaflet/leaflet.ie.css" /><![endif]-->
	
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	
	    <!-- jQuery. It's not required for Kothic, but still useful for this example -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
	
	<script src="leaflet/leaflet.js"></script>
	<script src="kothic.js"></script>
	<script src="kothic-leaflet.js"></script>

	<!-- Kothic style -->
	<script src="osmosnimki.js"></script>
	
	<link rel="stylesheet" href="blueprint/screen.css" type="text/css" media="screen, projection">
	<!--[if lt IE 8]><link rel="stylesheet" href="blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
	
  	<style>
		body {
			padding: 0;
			margin: 0;
			}
		html, body, #map {
			height: 100%;
			}
		#debug {
			position: absolute;
			top: 0;
			right: 0;
			background: rgba(255,255,255,0.7);
			border: 1px solid #ddd;
			padding: 15px 10px 10px;
			z-index: 10000;
			width: 160px;
			}
		#about {
			font-size: 14px;
			line-height: 1.3;
			}
		#trace {
			font-size: 11px;
			line-height: 1.3;
			}
		#mapnik {
			margin-bottom: 15px;
			}
		#debug p {
			margin-bottom: 10px;
			}
		table {
			margin: 3px 0 0 0;
			border-collapse: collapse;
			}
		table td {
			padding: 0 10px 0 0;
			}
		tbody tr:nth-child(even) td, tbody tr.even td {
			background: none;
		}
		#debug label {
			font-weight: normal;
		}
		#debug hr {
			margin-bottom: 10px;
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="debug">
		<p id="about">OpenStreetMap data rendered <em>on the browser</em> using <strong><a href="http://github.com/kothic/kothic-js">Kothic JS</a></strong><br /></p>
		<button id="mapnik" onclick="toggleMapnik()">Compare with Mapnik</button>
		<hr />
		<p>
			<input type="checkbox" onclick="toggleNonames()" id="nonames" /><label for="nonames"> Highlight no-names</label><br />
			<input type="checkbox" onclick="toggleAddressing()" id="addressing" /><label for="addressing"> Highlight addressing</label>
		</p>
		<hr />
		<div id="trace">Rendering...</div>
	</div>
	<script>
		var mapnik = new L.TileLayer('http://tile.osmosnimki.ru/kosmo/{z}/{x}/{y}.png', {
			attribution: "Map data &copy; 2011 OpenStreetMap contributors, Imagery by <a href='http://osmosnimki.ru'>osmosnimki.ru</a>",
			maxZoom: 22
		});
		
		var kothic = new L.TileLayer.Kothic({minZoom: 8});
		
		/*kothic.setAdditionalStyle(function(style, tags, zoom, type, sel) {
			//...
		});*/
		
		var map = new L.Map('map', {
			center: new L.LatLng(53.9, 27.55), // Minsk 
			zoom: 12
		});

		kothic.on('load', function() {
      var messages = kothic.getDebugMessages(),
        len = messages.length,
        messages = messages.slice(Math.max(len - 4, 0), len);

      showMessages(messages);
		});
		
		MapCSS.onImagesLoad = function() {
			map.addLayer(kothic);
		};
		MapCSS.preloadSpriteImage("osmosnimki-maps", "http://osmosnimki.ru/leaf/icons/osmosnimki.png");
		
		
		var mapnikVisible = false,
			button = document.getElementById('mapnik');
		
		function showMessages(messages) {
      $('#trace').empty();
      $(messages).each(function(index, msg) {
        $('<div>', {
          class: 'tileIndex', 
          text: msg.x + ":" + msg.y + ":" + msg.zoom
        }).appendTo($('#trace'));

        var stats = $('<table>', {
          style: 'display: none'
        }).appendTo($('#trace'));
            for (var k in msg.stats) {
                if (!msg.stats.hasOwnProperty(k)) {
                    continue;
                }

          $("<tr>").append($("<td>", {
            'text': msg.stats[k]
          })).append($("<td>", {
            'text': k
          })).appendTo(stats);
            }

        var log = $('<table>').appendTo($('#trace')),
          t0 = msg.events[0].timestamp,
          t1 = msg.events[msg.events.length - 1].timestamp,
          total = t1 - t0;
            for (var i = 1; i < msg.events.length; i++) {

          $("<tr>").append($("<td>", {
            class: 'time',
            text: (msg.events[i].timestamp - t0) + " ms"
          })).append($("<td>", {
            text: msg.events[i].message
          })).appendTo(log);

          t0 = msg.events[i].timestamp;
            }

            log.append('<tr><th>' + total + 'ms</th><td>total</td></tr>');
      });
      
    }
		
		function toggleMapnik() {
			if (mapnikVisible) {
				map.removeLayer(mapnik);
				button.innerHTML = 'Compare with Mapnik';
			} else {
				map.addLayer(mapnik);
				button.innerHTML = 'Hide Mapnik';
			}
			mapnikVisible = !mapnikVisible;
		}
		
		function toggleNonames() {
			if (document.getElementById('nonames').checked) {
				kothic.setAdditionalStyle(function(style, tags, zoom, type, sel) {
					var names = ['primary', 'secondary', 'tertiary', 'residential'];
	
					if (names.indexOf(tags['highway']) != -1 && !tags['ref'] && !tags['name']) {
						style['default']['color'] = 'red';
					}
				});
			} else {
				kothic.setAdditionalStyle(null);
			}
		}
		
		function toggleAddressing() {
			if (document.getElementById('addressing').checked) {
				kothic.setAdditionalStyle(function(style, tags, zoom, type, sel) {
					var s = style['default'];
					if (tags.building == 'yes') {
						if (tags.name || tags['addr:housename']) {
							s['fill-color'] = 'blue';
						} else if (tags['addr:housenumber']) {
							s['fill-color'] = 'green';
						} else {
							s['fill-color'] = 'red';
						}
					}
				});
			} else {
				kothic.setAdditionalStyle(null);
			}
		}
	</script>
</body>
</html>
